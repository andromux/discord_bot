import discord
from discord.ext import commands
import httpx
from urllib.parse import quote

class Releases(commands.Cog):
    def __init__(self, bot):
        self.bot = bot
        # Valores predeterminados
        self.default_owner_repo = "Sploder-Saptarshi/sm64coopdx-android"
        self.default_workflow = "build-coop.yaml"

    @commands.command(
        name="splod32",
        help="Muestra los √∫ltimos artefactos de la acci√≥n build-coop.yaml. Uso: !splod32"
    )
    async def splot32(self, ctx):
        owner_repo = self.default_owner_repo
        workflow = self.default_workflow
        owner, repo = owner_repo.split("/")
        headers = {"Accept": "application/vnd.github+json"}

        await ctx.send(f"üîç Obteniendo √∫ltimos artefactos de `{owner_repo}`...")

        # Obtener el √∫ltimo run exitoso
        try:
            url_runs = f"https://api.github.com/repos/{owner}/{repo}/actions/workflows/{workflow}/runs"
            params = {"status": "completed", "conclusion": "success", "per_page": 1}
            resp = httpx.get(url_runs, headers=headers, params=params, timeout=30.0)
            resp.raise_for_status()
            runs = resp.json().get("workflow_runs", [])
            if not runs:
                await ctx.send("‚ö†Ô∏è No se encontr√≥ un run exitoso para este workflow.")
                return
            run_id = runs[0]["id"]
        except Exception as e:
            await ctx.send(f"‚ùå Error al obtener el √∫ltimo run: {str(e)}")
            return

        # Obtener artefactos
        try:
            url_artifacts = f"https://api.github.com/repos/{owner}/{repo}/actions/runs/{run_id}/artifacts"
            resp = httpx.get(url_artifacts, headers=headers, timeout=30.0)
            resp.raise_for_status()
            artifacts = resp.json().get("artifacts", [])
            if not artifacts:
                await ctx.send("‚ö†Ô∏è No hay artefactos disponibles en este run.")
                return
        except Exception as e:
            await ctx.send(f"‚ùå Error al obtener artefactos: {str(e)}")
            return

        # Crear embed
        embed = discord.Embed(
            title=f"üì¶ Artefactos del √∫ltimo run ({run_id})",
            description=f"Repositorio: `{owner_repo}`",
            color=discord.Color.orange()
        )

        for art in artifacts:
            name = art["name"]
            size_mb = int(art["size_in_bytes"]) // 1024 // 1024
            safe_name = quote(name)
            link = f"https://nightly.link/{owner}/{repo}/actions/runs/{run_id}/{safe_name}.zip"
            embed.add_field(name=f"{name} ({size_mb} MB)", value=f"[Descargar aqu√≠]({link})", inline=False)

        # Link general al run
        embed.add_field(name="üåê Todos los artefactos", value=f"[Abrir en Nightly]({f'https://nightly.link/{owner}/{repo}/actions/runs/{run_id}'})", inline=False)

        # Enviar embed
        try:
            await ctx.send(embed=embed)
        except discord.Forbidden:
            await ctx.send(f"‚ö†Ô∏è No pude enviar los artefactos en este canal.")

# ----------- Setup -----------
async def setup(bot):
    await bot.add_cog(Releases(bot))
